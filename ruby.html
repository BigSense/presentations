<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8" />

    <title>BigSense.io</title>

    <meta name="description" content="Presentation for BigSense.io" />
    <meta name="author" content="Sumit Khanna" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" />

    <link rel="stylesheet" href="css/reveal.css" />
    <link rel="stylesheet" href="css/theme/serif.css" id="theme" />

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css" />

    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="stylesheet" href="css/custom.css" />

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
<section data-markdown>
  <script type="text/template">
  # BigSense
### Using Ruby to build virtual environments for Sensor Networks

[Sumit Khanna](http://penguindreams.org "Website") / [@djsumdog](:http://twitter.com/djsumdog "Twitter")
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## Overview 

- Green Learning Station
- Technology Stack
- vSense
  - Code
  - Examples
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## BigSense.io

- Cincinnati, Ohio
- Andrew Rettig
- Embedded Linux Systems
- Gather environmental sensor data
  - Weather
  - Rain Fall
  - Temperature
  - Barometer

  </script>
</section>

<section><section>
  <h2>Original Purpose</h2>
  <p>Combined Sewer Systems</p>
  <video>
    <source src="videos/CSO_5.webm" type="video/webm" />
    <source src="videos/CSO_5.mp4"  type="video/mp4" />
  </video>
</section>
<section>
  <h2>Original Purpose</h2>
  <p>Combined Sewer Systems</p>
  <video>
    <source src="videos/CSO_5part2.webm" type="video/webm" />
    <source src="videos/CSO_5part2.mp4"  type="video/mp4" />
  </video>
</section></section>

<section><section>
  <h2>Green Learning Station</h2>
  <img src="images/GLS-level.jpg" alt="Green Learning Station Pavement Test Area" />
</section>
<section>
  <h2>Green Learning Station</h2>
  <img src="images/GLS-top.png" alt="Green Learning Station Pavement Test Area (Top View)" />
</section>
<section>
  <h2>Green Learning Station</h2>
  <img src="images/GLS-side.jpg" alt="Green Learning Station Pavement Test Area (Side View)" width="600px" />
</section>
<section>
  <h2>Green Learning Station</h2>
  <img src="images/GreenLearningStationMap.png" alt="Green Learning Station Map" width="600px" />
</section></section>

<section><h2>Methodology</h2>
<img src="images/GLS-sitespec.jpg" alt="Site Specifications" /></section>

<section><h2>Linksys Running OpenWRT</h2>
<img src="images/el2100.jpg" alt="Linksys Router Running OpenWRT" width="600px" /></section>

<section><h2>Sensor Relays</h2>
<img src="images/routers.jpg" alt="Sensor Relay Cabinet" width="600px" /></section>

<section><h2>GPS</h2>
<img src="images/sensor_gps.png" alt="Sensor GPS Locations" /></section>

<section data-markdown>
  <script type="text/template">
  ## BigSense Data Flow

![Data Flow Diagram](images/DataFlowDiagram.png)
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## Technology Stack

- BigSense Web service written in Scala
  - embedded Tomcat/Jetty
- LtSense Client written in Python
  - Queue system for unreliable networks
  - Multi-format support (XML)
  - Support for 1-Wire sensors via One Wire File System (OWFS)
- vSense Virtual Environment written in Ruby
  - Vagrant, Ansible
- Originally packaged for OpenWRT
- Currently packaged for Ubuntu 14, Debian 7/8, CentOS 7 and openSUSE 13
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## vSense

- Written in Ruby
- Vagrant + Ansible
- Creates VM Sets
  - Build
  - Runtime
  - Infrastructure
- VirtualBox (development)
- libvirt + kvm (production)
- security
  - SSH keys
  - Password scrambling
  </script>
</section>
<section>
<section data-markdown>
  <script type="text/template">
  ## vSense


```
./vsense
Usage: vsense [ create | list | genkeys | destroy | start | stop | status | secure ]

	 create  - creates a new environment
	 list    - list of all environments
	 genkeys - generate PGP keys for a build environment
	 destroy - stop and delete all files associated with an environment
	 start   - start an environment
	 stop    - stop an environment
	 status  - display the status of an environment
	 secure  - configures production level security for all environments

add -h or --help for additional argumnets for each command
```
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## vSense

```
./vsense create
Usage: vsense create [-f <fixture>] [-e <env_type>] [-b <build_env>] [-d <db>] [-o <os>] [-s <stage>] <environment name>
    -f, --fixtures FIXTURE           Install fixtures (gls)
    -e, --env ENVIRONMENT            Environment type (build|run|infrastructure) [default: run]
    -d, --database DATABASE          Database backend (mysql|postgres|mssql)
    -o, --os RUN_OS                  Runtime OS/distribution (ubuntu|debian|centos|opensuse) [default: ubuntu]
    -s, --stage STAGE                Stage (nightly|testing|stable) [default: stable]
    -b, --build BUILD                Use a local build environment [default: use official bigsense.io]
    -h, --help                       Show this message

```
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## vSense

```
./vsense secure
Usage: vsense secure [-s <key_file> ] [-p <gpg key id> [-f]]
    -s, --ssh KEY                    SSH identity for vagrant user in all new VMs
    -p, --pgp ID                     ID of PGP key to use for password encryption
    -f, --force                      Overwrite existing PGP ID in /home/sumit/.password-store/.gpg-id
    -h, --help                       Show this message
```

- Additional Dependencies
  - whois (mkpasswd)
  - pwgen
  - pass (optional)
  </script>
</section>
</section><section>
<section data-markdown>
  <script type="text/template">
  ## Environment Types

- Runtime
  - BigSense, LtSense, Database
  - MySQL, PostgreSQL, MS SQL (coming soon)
  - Ubuntu, CentOS, Debian, openSUSE
- Build
  - Jenkins
  - Repository (rpm/apt)
- Infrastructure
  - Wiki
  - HAProxy
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## vSense Structure

```
vSense
├── ansible
├── core
├── fixtures
├── lib
├── LICENSE
├── README.md
├── virtual-env
└── vsense
```
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## Ansible Structure

```
ansible/
├── bigsense.yml
├── build.yml
├── database.yml
├── haproxy.yml
├── ltsense.yml
├── repo.yml
├── roles
│   ├── ansible-jenkins
│   ├── bigsense
│   ├── build
│   ├── build-host
│   ├── database
│   ├── haproxy
│   ├── ltsense
│   ├── repo
│   ├── repo-client
│   ├── security
│   └── wiki
└── wiki.yml
```
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## Core Files

```
core
├── build
│   ├── environment.yml
│   └── Vagrantfile
├── infrastructure
│   ├── environment.yml
│   └── Vagrantfile
├── run
│   ├── environment.yml
│   └── Vagrantfile
└── vagrantenv.rb

```
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## Testing Fixtures

```
fixtures/
├── gls-data.mysql.bz2
└── gls-data.postgres.bz2

```
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## vSense Ruby Code

```
lib/
├── action.rb
├── colours.rb
├── create.rb
├── destroy.rb
├── env.rb
├── genkey.rb
├── secure.rb
└── vagrant.rb

```
  </script>
</section>
</section><section>
<section><h3>The Basic Action</h3>

<pre><code class="hljs ruby" style="">class Action

  BASE    = Pathname.new(File.join(File.dirname(File.expand_path __FILE__),'..')).realpath
  ENVS    = File.join(BASE,'virtual-env')
  ...

  def initialize(args) ...

  def set_options() ...

  def settings()
    YAML.load_file(File.join(ENVS,@args[0],'environment.yml'))
  end

  def optparse()
    if @opts.nil?
      STDERR.puts "Option Parser for Action is Unimplemented"
      exit 4
     ...

  def validate() ...

  def run() ...
</code></pre></section>

<section><h3>Secure Action Options</h3>

<pre><code class="hljs ruby">class SecureAction < Action

  GPG_ID_FILE = File.join(Dir.home, '.password-store', '.gpg-id')

  def set_options()
    super
    @options = {}
    @opts = OptionParser.new do |opts|

      opts.banner = 'Usage: vsense secure [-s &lt;key_file&gt; ] [-p &lt;gpg key id&gt; [-f]]'

      opts.on('-s', '--ssh KEY', 'SSH identity for vagrant user in all new VMs') do |f|
        @options[:ssh_key_file] = f
      end

      opts.on('-p', '--pgp ID', 'ID of PGP key to use for password encryption') do |id|
        @options[:pgp_id] = id
      end

      opts.on('-f', '--force', "Overwrite existing PGP ID in #{GPG_ID_FILE}") do |f|
        @options[:force_pgp] = f
      end

      opts.on_tail("-h", "--help", "Show this message") do
        STDERR.puts opts
        exit
      end

    end
  end
</code></pre></section>

<section><h3>Run Action Create Options</h3>

<pre><code class="hljs ruby">  def run()
    super

    if File.exists?(@env_dir)
      STDOUT.puts ('Environment already exists: %s' %[@env_dir]).red
      exit 2
    end

    ...
    
    else # default is :run

      puts ('Creating Runtime Environment: %s' % @args[0]).green

      # configuration

      for i in env_config['servers'].keys
        env_config['servers'][i]['hostname'].sub!('%env%',@args[0])
      end

      if not @options[:fixture].nil?
        env_config['fixture'] = @options[:fixture].to_s
      end

      # connected to a build environment?

      if not @options[:build].nil?
        build_config = YAML.load_file(File.join(ENVS,@options[:build],"environment.yml"))
        env_config['repository']['host'] = '%s.%s' % [build_config['servers']['repository']['hostname'], build_config['domain']]
        env_config['repository']['custom'] = true
        env_config['repository']['ip'] = build_config['servers']['repository']['ip']
        env_config['repository']['ip_regex'] = '^' + build_config['servers']['repository']['ip'].gsub('.','\.')
        env_config['repository']['protocol'] = 'http'
      end

      env_config['database']['type'] = @options[:database].to_s
      env_config['servers']['bigsense']['os'] = @options[:os].to_s
      env_config['servers']['ltsense']['os'] = @options[:os].to_s
      env_config['repository']['stage'] = @options[:stage].to_s

    end
</code></pre></section>
</section><section>
<section data-markdown>
  <script type="text/template">
  ## vSense/virtual-env/vsense.yml 

```
---
environments:
- name: build
  type: build
- name: org
  type: infrastructure
- name: gls
  type: run
security:
  pgp_id: 7ACLOZ8Y
boxes:
  ubuntu: baremettle/ubuntu-14.04
  debian: zauberpony/wheezy
  centos: hansode/centos-7.0.1406-x86_64
  opensuse: alchemy/opensuse-13.2-64

```
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## demo1/environment.yml

```
---
name: demo1
type: run
domain: internal
repository:
  custom: false
  protocol: https
  host: repo.bigsense.io
  stage: nightly
servers:
  bigsense:
    hostname: bigsense-demo1
    os: ubuntu
    ip: 10.11.1.20
  ltsense:
    hostname: ltsense-demo1
    os: ubuntu
    ip: 10.11.1.21
  database:
    hostname: db-demo1
    ip: 10.11.1.22
database:
  type: mysql
  name: bigsense
  username: bigsense
  password: bigsense
  ddl_username: bigsense_ddl
  ddl_password: bigsense_ddl
bigsense:
  security_manager: DisabledSecurityManager
  http_port: 8080
  server: tomcat
```
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## builder/environment.yml

```
---
name: builder
type: build
domain: internal
servers:
  repository:
    hostname: repo
    ip: 10.11.1.10
  build:
    hostname: build
    ip: 10.11.1.11
    bigsense_src: http://github.com/BigSense/BigSense
    bigsense_tester_src: http://github.com/BigSense/BigSenseTester
    ltsense_src : http://github.com/BigSense/LtSense
pgp:
  key_type: DSA
  key_length: 1024
  subkey_type: ELG-E
  subkey_length: 1024
  name: http://example.org
  comment: BigSensePGPKey
  expire: 0
  passphrase: changeme
scm:
  polling: true
  polling_interval: H/15 * * * *

```
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## core/environment.yml

```
---
name: core
type: infrastructure
domain: internal
ext_gq: 10.42.7.1
servers:
  haproxy:
    hostname: haproxy
    ip: 10.11.2.10
    ext_iface: eth1
    ext_ip: 10.22.2.10
  wiki:
    hostname: wiki
    ip: 10.22.2.12
confluence:
  version: 5.6.6
  db_name: confluence
  db_user: confluence
  db_pass: wikipass
haproxy:
  vhosts:
    - { subdomain: repo , ip: 10.11.1.10 , port: 80 }
    - { ip: 10.22.2.12 , port: 8090 }
```
  </script>
</section>
</section><section>
<section><h3>Environment</h3>

<pre><code class="hljs ruby" style="">require 'yaml'
require_relative "action"

class Environment

  DEFAULT_VIRTUALBOX_IMGS = {
    'ubuntu' => 'ubuntu/trusty64',
    'debian' => 'puppetlabs/debian-7.8-64-nocm',
    'centos' =>  'chef/centos-7.0',
    'opensuse' => 'webhippie/opensuse-13.1'
  }

  ENV_FILE = File.join(Action::ENVS,'vsense.yml')
  @@settings = File.exists?(ENV_FILE) ? YAML.load_file(ENV_FILE) : { 'environments' => [], 'security' => {}, 'boxes' => DEFAULT_VIRTUALBOX_IMGS }
  @@env_settings = @@settings['environments']
  @@sec_settings = @@settings['security']

  def self.add(name,env_type)
    @@env_settings << { 'name' => name , 'type' => env_type }
    save_env_list
  end

  def self.del(name)
    @@settings['environments'] = @@env_settings.reject { |h| h['name'] == name }
    save_env_list
  end
</code></pre></section>

<section><h3>Environment</h3>

<pre><code class="hljs ruby" style="">class VagrantEnv

  def initialize(global_yml='../vsense.yml', local_yml='environment.yml')
    @vars = YAML.load_file(local_yml)
    @vsense = YAML.load_file(global_yml)
  end

  # security

  def ssh_security_enabled?()
    not @vsense['security']['ssh_key_file'].nil?
  end

  def ssh_identity_key_file()
    @vsense['security']['ssh_key_file']
  end

  # end security

  def ip(server)
    @vars['servers'][server]['ip']
  end
</code></pre></section>

<section><h3>Environment</h3>

<pre><code class="hljs ruby" style="">VAGRANTFILE_API_VERSION = "2"

require './vagrantenv'
vars = VagrantEnv.new

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

  config.vm.box = vars.vbox_image('ubuntu')

  if vars.ssh_security_enabled?
    config.ssh.private_key_path = [ File.join(ENV['HOME'], '.vagrant.d', 'insecure_private_key') , vars.ssh_identity_key_file()]
  end

  config.hostmanager.enabled = true
  config.hostmanager.manage_host = true
  config.hostmanager.ignore_private_ip = false
  config.hostmanager.include_offline = true

  config.vm.define "database" do |database|
    database.vm.network :private_network, ip: vars.ip('database')
    database.vm.hostname = vars.hostname('database')
    database.hostmanager.aliases = vars.aliases('database')
    database.vm.provision "ansible" do |ansible|
      ansible.playbook = "ansible/database.yml"
    end
  end
  ...
</code></pre></section>

<section data-markdown>
  <script type="text/template">
  ## Environment (ansible)


```
---
- name: BigSense Server
  hosts: bigsense
  sudo: true
  vars_files:
    - ../environment.yml
  roles:
   - security
   - { role: build-host, when: repository.custom == true }
   - bigsense
```
  </script>
</section>
</section><section>
<section data-markdown>
  <script type="text/template">
  ### vSense Demo

<iframe src="screencasts/vsense-demo.html" width="1000px" height="800px"></iframe>
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ### vSense Demo

![BigSense Web Service Query Screenshot](images/vsense-rest.png)
  </script>
</section>

<section><h3>Sense XML</h3>
<pre><code class="hljs xml"><?xml version="1.0"?>
<SenseData>
    <package id="OneWireTester" timestamp="1428192392795">
        <sensors>
            <sensor id="AGEWA99B" type=" Temperature" units="C">
                <data>34</data>
            </sensor>
            <sensor id="WTR001AD-V" type="Volume" units="ml">
                <data>50</data>
            </sensor>
            <sensor id="WTR001AD-FR" type="FlowRate" units="ml/s">
            <data>2.45</data>
        </sensor>
    </sensors>
</package>
</SenseData></code></pre></section>
</section><section>
<section><h2>BigSense Web Service API</h2>
<img src="images/bigsense_api.png" alt="BigSense API Chart" /></section>

<section><h2>Example Query</h2>
<img src="images/example-query.png" alt="Example Query" /></section>

<section data-markdown>
  <script type="text/template">
  ### Example Aggregate Query

    http://bigsense:8080/aggregate/SumVolume/DateRange/20120501/20120510/1440.table.html?Timezone=EST5EDT&Units=Standard

![Aggregate Query Result in HTML Table Format](images/bigsense-example-aggregate.png)
  </script>
</section>
</section>
<section data-markdown>
  <script type="text/template">
  ## Contributing

- Help test with vSense
  - http://github.com/bigsense/vsense
- Raspberry Pi Support
- Beagle Bone Black Support
- I2C support
- Funding
  - Grants, Sponsorship, Fellowship
- Mailing List
  - https://groups.google.com/group/bigsense
  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ### Source Code

<img src="images/octo-nan.gif" alt="Nan-cat animated Github logo" style="width: 250px; float:right; border: none;" />

- http://github.com/bigsense/BigSense
- http://github.com/bigsense/BigSenseTester
- http://github.com/bigsense/LtSense
- http://github.com/bigsense/vSense
- http://github.com/bigsense/presentations

  </script>
</section>

<section data-markdown>
  <script type="text/template">
  ## Questions?


  </script>
</section>
      </div>

<img src="images/logo.png" style="
                        position: absolute;
                        bottom: 50px;
                        right: 35px;
                        width: 300px;" />

    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,
        width: '80%',
        //height: '80%',

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
